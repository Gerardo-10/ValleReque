window.initDetalleEmpleado = function () {
    // Referencias a elementos del DOM
    const btnAgregarEmpleado = document.getElementById('btnAgregarEmpleado');
    const btnActualizarInfo = document.getElementById('btnActualizarInfo');
    const btnCambiarPassword = document.getElementById('btnCambiarPassword');

    const modalAgregarEmpleado = document.getElementById('modalAgregarEmpleado');
    const modalActualizarInfo = document.getElementById('modalActualizarInfo');
    const modalCambiarPassword = document.getElementById('modalCambiarPassword');
    const modalExito = document.getElementById('modalExito');
    const modalOverlay = document.getElementById('modalOverlay');

    const cerrarModalAgregar = document.getElementById('cerrarModalAgregar');
    const cerrarModalActualizar = document.getElementById('cerrarModalActualizar');
    const cerrarModalPassword = document.getElementById('cerrarModalPassword');
    const cerrarModalExito = document.getElementById('cerrarModalExito');

    const btnCancelarAgregar = document.getElementById('btnCancelarAgregar');
    const btnCancelarActualizar = document.getElementById('btnCancelarActualizar');
    const btnCancelarPassword = document.getElementById('btnCancelarPassword');

    const formAgregarEmpleado = document.getElementById('formAgregarEmpleado');
    const formActualizarInfo = document.getElementById('formActualizarInfo');
    const formCambiarPassword = document.getElementById('formCambiarPassword');

    const togglePasswordBtns = document.querySelectorAll('.toggle-password');

    // Funciones para manejar modales
    function abrirModal(modal) {
        if (modal) {
            modal.classList.add('activo');
            modalOverlay.classList.add('activo');
            document.body.style.overflow = 'hidden'; // Prevenir scroll
        }
    }

    function cerrarModal(modal) {
        if (modal) {
            modal.classList.remove('activo');
            modalOverlay.classList.remove('activo');
            document.body.style.overflow = ''; // Restaurar scroll
        }
    }

    function cerrarTodosLosModales() {
        const modales = document.querySelectorAll('.modal');
        modales.forEach(modal => {
            modal.classList.remove('activo');
        });
        modalOverlay.classList.remove('activo');
        document.body.style.overflow = ''; // Restaurar scroll
    }

    // Función para mostrar modal de éxito
    function mostrarExito(titulo, mensaje, mostrarCredenciales = false) {
        const tituloExito = document.getElementById('tituloExito');
        const mensajeExito = document.getElementById('mensajeExito');
        const credencialesContainer = document.getElementById('credencialesContainer');

        if (tituloExito && mensajeExito) {
            tituloExito.textContent = titulo;
            mensajeExito.textContent = mensaje;
        }

        if (mostrarCredenciales && credencialesContainer) {
            // Generar credenciales aleatorias para demostración
            const usuario = 'r.' + Math.random().toString(36).substring(2, 8);
            const password = 'Pass' + Math.floor(Math.random() * 10000) + '!';

            const usuarioGenerado = document.getElementById('usuarioGenerado');
            const passwordGenerada = document.getElementById('passwordGenerada');

            if (usuarioGenerado && passwordGenerada) {
                usuarioGenerado.textContent = usuario;
                passwordGenerada.textContent = password;
            }

            credencialesContainer.style.display = 'block';
        } else if (credencialesContainer) {
            credencialesContainer.style.display = 'none';
        }

        abrirModal(modalExito);
    }

    // Manejar envío de formularios
    if (formAgregarEmpleado) {
        formAgregarEmpleado.addEventListener('submit', function (e) {
            e.preventDefault();
            // Aquí iría la lógica para enviar datos al servidor
            cerrarModal(modalAgregarEmpleado);
            setTimeout(() => {
                mostrarExito(
                    'Empleado Agregado Exitosamente',
                    'El nuevo empleado ha sido registrado en el sistema. A continuación se muestran las credenciales generadas:',
                    true
                );
            }, 500);
        });
    }

    if (formActualizarInfo) {
        formActualizarInfo.addEventListener('submit', function (e) {
            e.preventDefault();

            // Obtener los valores directamente del DOM
            const idEmpleado = document.getElementById('idActualizar').value;
            const nombre = document.getElementById('nombreActualizar').value;
            const apellido = document.getElementById('apellidoActualizar').value;
            const correo = document.getElementById('emailActualizar').value;
            const fecha_nacimiento = document.getElementById('fechaNacActualizar').value;
            const telefono = document.getElementById('telefonoActualizar').value;
            const direccion = document.getElementById('direccionActualizar').value;

            // Validación básica
            if (!idEmpleado) {
                alert('Error: No se encontró el ID del empleado.');
                return;
            }

            // Preparar el objeto a enviar
            const data = {
                id_empleado: idEmpleado,
                nombre: nombre,
                apellido: apellido,
                correo: correo,
                fecha_nacimiento: fecha_nacimiento,
                telefono: telefono,
                direccion: direccion
            };

            fetch('/actualizar_empleado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formActualizarInfo.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la solicitud');
                    }
                    return response.json();
                })
                .then(respuesta => {
                    if (respuesta.success) {
                        cerrarModal(modalActualizarInfo);
                        mostrarExito('Información Actualizada', 'Los datos del empleado han sido actualizados correctamente.');

                        // ✅ Actualizar datos en la vista (DOM)
                        document.getElementById('nombreEmpleado').textContent = nombre + ' ' + apellido;
                        document.getElementById('correoEmpleado').textContent = correo;
                        document.getElementById('telefonoEmpleado').textContent = telefono;
                        document.getElementById('fechaNacimientoEmpleado').textContent = fecha_nacimiento;
                        document.getElementById('direccionEmpleado').textContent = direccion;


                    } else {
                        alert('Error: ' + respuesta.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ocurrió un error al actualizar.');
                });
        });
    }

    if (formCambiarPassword) {
        formCambiarPassword.addEventListener('submit', function (e) {
            e.preventDefault();

            const idEmpleado = document.getElementById('idActualizarCuenta').value;
            const passwordActual = document.getElementById('passwordActual').value;
            const passwordNueva = document.getElementById('passwordNueva').value;
            const passwordConfirmar = document.getElementById('passwordConfirmar').value;
            const csrfToken = document.querySelector('[name="csrf_token"]').value;  // AGREGADO

            const formData = new FormData();
            formData.append('id_empleado', idEmpleado);
            formData.append('password_actual', passwordActual);
            formData.append('password_nueva', passwordNueva);
            formData.append('password_confirmar', passwordConfirmar);
            formData.append('csrf_token', csrfToken);  // AGREGADO

            fetch('/actualizar_contrasena', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) throw new Error('Error en la solicitud');
                    return response.json();
                })
                .then(data => {
                    cerrarModal(modalCambiarPassword);
                    if (data.success) {
                        mostrarExito('Contraseña Actualizada', data.message);
                    } else {
                        mostrarError('Error al cambiar contraseña', data.message);
                    }
                })
                .catch(error => {
                    cerrarModal(modalCambiarPassword);
                    mostrarError('Error', 'No se pudo procesar la solicitud');
                    console.error('Error:', error);
                });
        });
    }

    // Mostrar/ocultar contraseña
    if (togglePasswordBtns.length > 0) {
        togglePasswordBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const input = this.previousElementSibling;
                const tipo = input.getAttribute('type');

                if (tipo === 'password') {
                    input.setAttribute('type', 'text');
                    this.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    input.setAttribute('type', 'password');
                    this.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        });
    }

    // Event listeners para botones
    if (btnAgregarEmpleado) {
        btnAgregarEmpleado.addEventListener('click', () => abrirModal(modalAgregarEmpleado));
    }

    if (btnActualizarInfo) {
        btnActualizarInfo.addEventListener('click', () => abrirModal(modalActualizarInfo));
    }

    if (btnCambiarPassword) {
        btnCambiarPassword.addEventListener('click', () => abrirModal(modalCambiarPassword));
    }

    if (cerrarModalAgregar) {
        cerrarModalAgregar.addEventListener('click', () => cerrarModal(modalAgregarEmpleado));
    }

    if (cerrarModalActualizar) {
        cerrarModalActualizar.addEventListener('click', () => cerrarModal(modalActualizarInfo));
    }

    if (cerrarModalPassword) {
        cerrarModalPassword.addEventListener('click', () => cerrarModal(modalCambiarPassword));
    }

    if (cerrarModalExito) {
        cerrarModalExito.addEventListener('click', () => cerrarModal(modalExito));
    }

    if (btnCancelarAgregar) {
        btnCancelarAgregar.addEventListener('click', () => cerrarModal(modalAgregarEmpleado));
    }

    if (btnCancelarActualizar) {
        btnCancelarActualizar.addEventListener('click', () => cerrarModal(modalActualizarInfo));
    }

    if (btnCancelarPassword) {
        btnCancelarPassword.addEventListener('click', () => cerrarModal(modalCambiarPassword));
    }

    if (modalOverlay) {
        modalOverlay.addEventListener('click', cerrarTodosLosModales);
    }

    // Cerrar modales con ESC
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            cerrarTodosLosModales();
        }
    });

    btnActualizarInfo.addEventListener('click', function () {
        // Obtener los valores desde los atributos data-*
        const nombre = this.getAttribute('data-nombre');
        const apellido = this.getAttribute('data-apellido');
        const correo = this.getAttribute('data-correo');
        const telefono = this.getAttribute('data-telefono');
        const fechaNacimiento = this.getAttribute('data-fecha-nacimiento');
        const direccion = this.getAttribute('data-direccion');

        // Setear los valores en el formulario del modal
        document.getElementById('nombreActualizar').value = nombre;
        document.getElementById('apellidoActualizar').value = apellido;
        document.getElementById('emailActualizar').value = correo;
        document.getElementById('telefonoActualizar').value = telefono;
        document.getElementById('fechaNacActualizar').value = fechaNacimiento;
        document.getElementById('direccionActualizar').value = direccion;

        // Abrir el modal
        abrirModal(modalActualizarInfo);
    });

    function mostrarError(titulo, mensaje) {
    alert(titulo + '\n' + mensaje);
    console.error(titulo, mensaje);
}
};
